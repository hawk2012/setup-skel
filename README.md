# 🛠️ Автоматизация настройки `.ssh/authorized_keys` через `/etc/skel`

## 📄 Описание

Этот проект демонстрирует автоматизированную настройку шаблона домашнего каталога новых пользователей в Linux с помощью скрипта `setup-skel.sh`. После его выполнения каждый **новый пользователь**, созданный с опцией `-m`, будет автоматически получать правильно настроенный каталог `.ssh` и файл `authorized_keys` — что критически важно для безопасного и удобного доступа по SSH.

> ✅ Идеально подходит для DevOps-инфраструктуры: облачные серверы, CI/CD-агенты, административные учётные записи.

---

## 💾 Полный скрипт: `setup-skel.sh`

```bash
#!/bin/bash
# setup-skel.sh — Настраивает /etc/skel для автоматического создания .ssh/authorized_keys

set -euo pipefail

SKEL_DIR="/etc/skel"
SSH_DIR="$SKEL_DIR/.ssh"
AUTH_KEYS="$SSH_DIR/authorized_keys"

echo "Настройка /etc/skel для автоматического создания .ssh/authorized_keys..."

# 1. Создаём директории
mkdir -p "$SSH_DIR"

# 2. Создаём пустой authorized_keys
touch "$AUTH_KEYS"

# 3. Устанавливаем правильные права
chmod 700 "$SSH_DIR"
chmod 600 "$AUTH_KEYS"

# 4. Меняем владельца на root (важно для /etc/skel)
chown -R root:root "$SKEL_DIR"
echo "Права установлены: .ssh/ — 700, authorized_keys — 600"

# 5. Проверяем, что useradd использует -m по умолчанию (копирует skel)
# Обычно в /etc/default/useradd уже есть CREATE_HOME=yes

echo "Готово! Теперь при создании пользователя:"
echo "  useradd -m username"
echo "домашний каталог будет включать .ssh/authorized_keys"

# Пример создания пользователя
echo ""
echo "Пример:"
echo "  useradd -m -s /bin/bash alice"
echo "  passwd alice"
```

---

## 🔧 Что делает скрипт?

| Шаг | Действие |
|-----|--------|
| 1 | Создаёт директорию `/etc/skel/.ssh` — шаблон для всех новых пользователей |
| 2 | Создаёт пустой файл `authorized_keys` для добавления SSH-ключей |
| 3 | Устанавливает безопасные права: `700` на `.ssh`, `600` на `authorized_keys` |
| 4 | Назначает владельца `root:root` — корректно для `/etc/skel` |
| 5 | Выводит подсказку по использованию и пример создания пользователя |

---

## 📌 Зачем это нужно?

По умолчанию:
- При создании пользователя через `useradd -m` система копирует `/etc/skel` в домашний каталог.
- Но если в `/etc/skel` нет `.ssh`, пользователь не может сразу использовать SSH-ключи.
- А ручное создание `.ssh` для каждого пользователя — долго и подвержено ошибкам.

✅ Этот скрипт решает проблему **одним запуском**:
- Гарантирует наличие `.ssh/authorized_keys`
- Обеспечивает правильные права (безопасность!)
- Поддерживает масштабируемость: подходит для 1 или 100 серверов

---

## 🚀 Как использовать

1. Запусти скрипт с правами `root`:
```bash
sudo ./setup-skel.sh
```

2. Создай нового пользователя:
```bash
sudo useradd -m -s /bin/bash bob
sudo passwd bob
```

3. Добавь SSH-ключ (например, через `ssh-copy-id` или вручную):
```bash
sudo su - bob -c "echo 'ssh-rsa AAAAB3...' >> .ssh/authorized_keys"
```

> 🔐 Файл уже существует и имеет правильные права — можно сразу добавлять ключи!

---

## 🛡️ Безопасность

- `chmod 700 .ssh` — только владелец может читать/писать/входить
- `chmod 600 authorized_keys` — запрещено чтение посторонним
- Владелец `root:root` на `/etc/skel` — соответствует стандартам безопасности
- `set -euo pipefail` — надёжный bash-скриптинг (выход при ошибках)

---

## 🔄 Идемпотентность и автоматизация

- Скрипт можно запускать несколько раз — ничего не сломается.
- Подходит для:
  - **Packer** — при сборке образов
  - **Ansible** — как часть роли по настройке пользователей
  - **Terraform** — через `remote-exec` provisioner
  - **Bash-прошивка серверов** — в startup-скриптах

---

## 📦 Где использовать?

| Сценарий | Применение |
|--------|-----------|
| Облачные серверы (AWS, GCP, Azure) | Быстрое развёртывание пользователей с SSH |
| CI/CD-агенты | Удобный доступ для техподдержки или отладки |
| Dev-среды | Автоматизация onboarding разработчиков |
| Безопасные хосты | Единый стандарт для всех пользователей |

---

## 📚 Технологии

- **Bash** — системная автоматизация
- **Linux** (Debian, Ubuntu, CentOS, RHEL и др.)
- **SSH** — безопасный удалённый доступ
- **User Management** — управление пользователями
- **Infrastructure as Code (IaC)** — часть автоматизированной настройки

---

## 🏁 Вывод

Этот скрипт — простой, но мощный пример **DevOps-мышления**:
- Автоматизация рутины
- Соблюдение security best practices
- Поддержка масштабируемости и повторяемости

🔧 Он показывает, как даже небольшой bash-скрипт может значительно улучшить управляемость и безопасность инфраструктуры.

> ✅ Отлично подходит для портфолио DevOps-инженера.

---

## 📂 Структура репозитория

```
.
├── setup-skel.sh     # Основной скрипт
├── README.md         # Документация (этот файл)
└── (опционально) test-setup.sh  # Тесты на работоспособность
```

---

> 📬 Связь: [platform@gubin.systems / [GitHub](https://github.com/hawk2012)]  
> 💼 DevOps Engineer | Linux | Automation | Security | IaC
