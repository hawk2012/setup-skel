#!/bin/bash
# setup-skel.sh ‚Äî –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç /etc/skel –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è .ssh/authorized_keys

set -euo pipefail

SKEL_DIR="/etc/skel"
SSH_DIR="$SKEL_DIR/.ssh"
AUTH_KEYS="$SSH_DIR/authorized_keys"

echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ /etc/skel –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è .ssh/authorized_keys..."

# 1. –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
mkdir -p "$SSH_DIR"

# 2. –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π authorized_keys
: > "$AUTH_KEYS"  # —Ç–æ –∂–µ, —á—Ç–æ touch, –Ω–æ —á—É—Ç—å —è—Å–Ω–µ–µ –ø–æ –Ω–∞–º–µ—Ä–µ–Ω–∏—é

# 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
chmod 700 "$SSH_DIR"
chmod 600 "$AUTH_KEYS"

# 4. –ú–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–∞ root (–≤–∞–∂–Ω–æ –¥–ª—è /etc/skel)
chown -R root:root "$SKEL_DIR"
echo "‚úÖ –ü—Ä–∞–≤–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: .ssh/ ‚Äî 700, authorized_keys ‚Äî 600"

# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ useradd —Å–æ–∑–¥–∞—ë—Ç –¥–æ–º–∞—à–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
USERADD_CONFIG="/etc/default/useradd"
if [ -f "$USERADD_CONFIG" ]; then
    if grep -q "^CREATE_HOME=yes" "$USERADD_CONFIG"; then
        echo "‚úÖ useradd –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–º–∞—à–Ω–∏—Ö –∫–∞—Ç–∞–ª–æ–≥–æ–≤."
    else
        echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: CREATE_HOME –Ω–µ –≤–∫–ª—é—á—ë–Ω –≤ $USERADD_CONFIG. –î–æ–±–∞–≤—å—Ç–µ: CREATE_HOME=yes"
    fi
else
    echo "‚ö†Ô∏è –§–∞–π–ª $USERADD_CONFIG –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ useradd –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ skel."
fi

# 6. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
echo ""
echo "‚ú® –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ñ–ª–∞–≥–æ–º -m:"
echo "     useradd -m -s /bin/bash username"
echo "–≤ –¥–æ–º–∞—à–Ω–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ:"
echo "     ~/.ssh/authorized_keys (–ø—É—Å—Ç–æ–π, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –≤—Ä—É—á–Ω—É—é)"
echo ""
echo "üìå –ü—Ä–∏–º–µ—Ä: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ SSH-–∫–ª—é—á–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è alice"
echo "     su - alice"
echo "     echo 'ssh-rsa AAA... user@host' >> ~/.ssh/authorized_keys"
echo "     chmod 600 ~/.ssh/authorized_keys"
echo "     chmod 700 ~/.ssh"
echo ""
echo "üîê –í–∞–∂–Ω–æ: —Ñ–∞–π–ª authorized_keys –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Å—Ç ‚Äî SSH-–¥–æ—Å—Ç—É–ø –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω."
echo "   –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π."
